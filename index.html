<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerala Line Break Detection System</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/wouter@2.12.1/dist/wouter.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
        .loading { display: flex; justify-content: center; align-items: center; height: 100vh; }
        
        /* Custom map styles */
        #kerala-map {
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .custom-div-icon {
            background: transparent !important;
            border: none !important;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .leaflet-popup-tip {
            background: white;
        }
        
        .leaflet-tooltip {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            padding: 4px 8px;
        }
        
        .leaflet-tooltip-top:before {
            border-top-color: rgba(0, 0, 0, 0.8);
        }
        
        .leaflet-tooltip-bottom:before {
            border-bottom-color: rgba(0, 0, 0, 0.8);
        }
        
        .leaflet-tooltip-left:before {
            border-left-color: rgba(0, 0, 0, 0.8);
        }
        
        .leaflet-tooltip-right:before {
            border-right-color: rgba(0, 0, 0, 0.8);
        }
        
        /* Emergency status indicators */
        .emergency-critical { animation: pulse 2s infinite; }
        .emergency-high { animation: pulse 3s infinite; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* Map controls */
        .leaflet-control-zoom a {
            background-color: white;
            border: 1px solid #ccc;
            color: #333;
        }
        
        .leaflet-control-zoom a:hover {
            background-color: #f4f4f4;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, createContext, useContext } = React;
        const { BrowserRouter, Routes, Route, Navigate, useLocation } = wouter;

        // Mock API Client
        const apiClient = {
            get: async (url) => {
                // Simulate API calls with mock data
                if (url.includes('/dashboard/summary')) {
                    return {
                        data: {
                            overview: {
                                totalSubstations: 5,
                                activeFeeders: 12,
                                totalEventsToday: 3,
                                activeEvents: 1,
                                resolvedEvents: 2,
                                modelAccuracy: 0.9687
                            },
                            recentEvents: [
                                {
                                    id: '1',
                                    feederName: 'TVM-CENTRAL-F01',
                                    detectedAt: new Date().toISOString(),
                                    status: 'detected',
                                    severity: 'high',
                                    estimatedLocationKm: 2.5
                                }
                            ],
                            alerts: { critical: 0, high: 1, medium: 0, low: 0 },
                            performance: {
                                avgDetectionTimeMs: 185,
                                avgResponseTimeMinutes: 12.5,
                                falsePositiveRate: 0.018
                            }
                        }
                    };
                }
                return { data: [] };
            },
            post: async (url, data) => {
                if (url.includes('/auth/login')) {
                    return {
                        data: {
                            user: { id: '1', fullName: 'Admin User', role: 'admin' },
                            tokens: { accessToken: 'mock-token' }
                        }
                    };
                }
                return { data: {} };
            }
        };

        // Auth Context
        const AuthContext = createContext();
        const useAuth = () => useContext(AuthContext);

        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isLoading, setIsLoading] = useState(false);

            const login = async (email, password) => {
                setIsLoading(true);
                try {
                    const response = await apiClient.post('/auth/login', { email, password });
                    setUser(response.data.user);
                    setIsAuthenticated(true);
                } catch (error) {
                    console.error('Login failed:', error);
                } finally {
                    setIsLoading(false);
                }
            };

            const logout = () => {
                setUser(null);
                setIsAuthenticated(false);
            };

            return (
                <AuthContext.Provider value={{ user, isAuthenticated, isLoading, login, logout }}>
                    {children}
                </AuthContext.Provider>
            );
        };

        // Login Component
        const LoginPage = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [, setLocation] = useLocation();
            const { login, isLoading } = useAuth();

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    await login(email, password);
                    setLocation('/');
                } catch (err) {
                    setError('Login failed');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50">
                    <div className="max-w-md w-full space-y-8 p-8">
                        <div className="text-center">
                            <h2 className="text-3xl font-bold text-gray-900">KSEBL Life Line</h2>
                            <p className="text-gray-600 mt-1">Line Break Detection System</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            {error && (
                                <div className="bg-red-100 text-red-800 p-3 rounded">
                                    {error}
                                </div>
                            )}
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"
                                    placeholder="admin@ksebl.gov.in"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"
                                    placeholder="Admin@123"
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={isLoading}
                                className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50"
                            >
                                {isLoading ? 'Signing in...' : 'Sign in'}
                            </button>
                        </form>
                        <div className="text-sm text-gray-600">
                            <p className="font-medium">Demo Account:</p>
                            <p>admin@ksebl.gov.in / Admin@123</p>
                        </div>
                    </div>
                </div>
            );
        };

        // Dashboard Component
        const DashboardPage = () => {
            const [summary, setSummary] = useState(null);
            const [loading, setLoading] = useState(true);
            const { user } = useAuth();
            const mapRef = useRef(null);
            const updateIntervalRef = useRef(null);

            useEffect(() => {
                loadDashboardData();
                initializeKeralaMap();
                
                // Cleanup function
                return () => {
                    if (updateIntervalRef.current) {
                        clearInterval(updateIntervalRef.current);
                    }
                    if (mapRef.current) {
                        mapRef.current.remove();
                    }
                };
            }, []);

            const loadDashboardData = async () => {
                try {
                    setLoading(true);
                    const response = await apiClient.get('/dashboard/summary');
                    setSummary(response.data);
                } catch (error) {
                    console.error('Failed to load dashboard data:', error);
                } finally {
                    setLoading(false);
                }
            };

            const initializeKeralaMap = () => {
                // Wait for DOM to be ready
                setTimeout(() => {
                    const mapContainer = document.getElementById('kerala-map');
                    if (!mapContainer) {
                        console.warn('Map container not found, retrying...');
                        setTimeout(initializeKeralaMap, 500);
                        return;
                    }

                    // Check if Leaflet is available
                    if (typeof L === 'undefined') {
                        console.error('Leaflet library not loaded');
                        return;
                    }

                    // Initialize Leaflet map with error handling
                    let map;
                    try {
                        map = L.map('kerala-map').setView([10.8505, 76.2711], 8);
                        mapRef.current = map; // Store map reference for cleanup
                    } catch (error) {
                        console.error('Failed to initialize map:', error);
                        return;
                    }

                    // Add OpenStreetMap tiles with error handling
                    try {
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                            errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                        }).addTo(map);
                    } catch (error) {
                        console.error('Failed to add tile layer:', error);
                    }

                    // Kerala district boundaries (simplified)
                    const keralaDistricts = [
                        {
                            name: 'Thiruvananthapuram',
                            coordinates: [[8.4, 76.8], [8.6, 77.0], [8.8, 77.2], [8.4, 77.4], [8.2, 77.2], [8.4, 76.8]],
                            center: [8.5241, 76.9361]
                        },
                        {
                            name: 'Kollam',
                            coordinates: [[8.8, 76.4], [9.0, 76.6], [9.2, 76.8], [8.8, 77.0], [8.6, 76.8], [8.8, 76.4]],
                            center: [8.8932, 76.6141]
                        },
                        {
                            name: 'Pathanamthitta',
                            coordinates: [[9.2, 76.6], [9.4, 76.8], [9.6, 77.0], [9.2, 77.2], [9.0, 77.0], [9.2, 76.6]],
                            center: [9.2648, 76.7870]
                        },
                        {
                            name: 'Alappuzha',
                            coordinates: [[9.4, 76.2], [9.6, 76.4], [9.8, 76.6], [9.4, 76.8], [9.2, 76.6], [9.4, 76.2]],
                            center: [9.4980, 76.3388]
                        },
                        {
                            name: 'Kottayam',
                            coordinates: [[9.6, 76.4], [9.8, 76.6], [10.0, 76.8], [9.6, 77.0], [9.4, 76.8], [9.6, 76.4]],
                            center: [9.5916, 76.5222]
                        },
                        {
                            name: 'Idukki',
                            coordinates: [[9.8, 76.6], [10.0, 76.8], [10.2, 77.0], [9.8, 77.2], [9.6, 77.0], [9.8, 76.6]],
                            center: [9.8252, 76.9955]
                        },
                        {
                            name: 'Ernakulam',
                            coordinates: [[10.0, 76.2], [10.2, 76.4], [10.4, 76.6], [10.0, 76.8], [9.8, 76.6], [10.0, 76.2]],
                            center: [10.0168, 76.3418]
                        },
                        {
                            name: 'Thrissur',
                            coordinates: [[10.4, 76.0], [10.6, 76.2], [10.8, 76.4], [10.4, 76.6], [10.2, 76.4], [10.4, 76.0]],
                            center: [10.5276, 76.2144]
                        },
                        {
                            name: 'Palakkad',
                            coordinates: [[10.6, 76.2], [10.8, 76.4], [11.0, 76.6], [10.6, 76.8], [10.4, 76.6], [10.6, 76.2]],
                            center: [10.7867, 76.6548]
                        },
                        {
                            name: 'Malappuram',
                            coordinates: [[10.8, 75.8], [11.0, 76.0], [11.2, 76.2], [10.8, 76.4], [10.6, 76.2], [10.8, 75.8]],
                            center: [11.0508, 76.0711]
                        },
                        {
                            name: 'Kozhikode',
                            coordinates: [[11.0, 75.6], [11.2, 75.8], [11.4, 76.0], [11.0, 76.2], [10.8, 76.0], [11.0, 75.6]],
                            center: [11.2588, 75.7804]
                        },
                        {
                            name: 'Wayanad',
                            coordinates: [[11.2, 75.8], [11.4, 76.0], [11.6, 76.2], [11.2, 76.4], [11.0, 76.2], [11.2, 75.8]],
                            center: [11.6850, 76.1320]
                        },
                        {
                            name: 'Kannur',
                            coordinates: [[11.4, 75.4], [11.6, 75.6], [11.8, 75.8], [11.4, 76.0], [11.2, 75.8], [11.4, 75.4]],
                            center: [11.8745, 75.3704]
                        },
                        {
                            name: 'Kasaragod',
                            coordinates: [[11.6, 75.2], [11.8, 75.4], [12.0, 75.6], [11.6, 75.8], [11.4, 75.6], [11.6, 75.2]],
                            center: [12.5000, 75.0000]
                        }
                    ];

                    // Add district boundaries with error handling
                    try {
                        keralaDistricts.forEach(district => {
                            L.polygon(district.coordinates, {
                                color: '#3B82F6',
                                weight: 2,
                                opacity: 0.6,
                                fillColor: '#DBEAFE',
                                fillOpacity: 0.1
                            }).addTo(map).bindTooltip(district.name, { direction: 'center' });
                        });
                    } catch (error) {
                        console.error('Failed to add district boundaries:', error);
                    }

                    // Emergency data
                    const emergencies = [
                        {
                            id: '1',
                            type: 'line_break',
                            severity: 'critical',
                            title: 'High Voltage Line Break - TVM Central',
                            description: '33kV transmission line break detected near Thiruvananthapuram Central.',
                            lat: 8.5241,
                            lng: 76.9361,
                            address: 'Near Secretariat, Thiruvananthapuram',
                            district: 'Thiruvananthapuram',
                            affectedCustomers: 2500,
                            reportedAt: new Date().toISOString(),
                            estimatedRestoration: new Date(Date.now() + 4 * 60 * 60 * 1000).toISOString(),
                            status: 'investigating',
                            phone: '+91-471-1234567',
                            team: 'TVM Emergency Response Team'
                        },
                        {
                            id: '2',
                            type: 'power_outage',
                            severity: 'high',
                            title: 'Area Power Outage - Kochi Metro',
                            description: 'Complete power outage in Kochi metro area due to transformer failure.',
                            lat: 10.0168,
                            lng: 76.3418,
                            address: 'Marine Drive, Kochi',
                            district: 'Ernakulam',
                            affectedCustomers: 1800,
                            reportedAt: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                            estimatedRestoration: new Date(Date.now() + 2 * 60 * 60 * 1000).toISOString(),
                            status: 'repairing',
                            phone: '+91-484-1234567',
                            team: 'Kochi Maintenance Team'
                        },
                        {
                            id: '3',
                            type: 'equipment_failure',
                            severity: 'medium',
                            title: 'Substation Equipment Failure',
                            description: 'Circuit breaker failure at Thrissur 132kV substation.',
                            lat: 10.5276,
                            lng: 76.2144,
                            address: 'Thrissur 132kV Substation',
                            district: 'Thrissur',
                            affectedCustomers: 1200,
                            reportedAt: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString(),
                            estimatedRestoration: new Date(Date.now() + 3 * 60 * 60 * 1000).toISOString(),
                            status: 'investigating',
                            phone: '+91-487-1234567',
                            team: 'Thrissur Technical Team'
                        },
                        {
                            id: '4',
                            type: 'storm_damage',
                            severity: 'high',
                            title: 'Storm Damage - Kozhikode',
                            description: 'Heavy storm caused multiple line damages in Kozhikode district.',
                            lat: 11.2588,
                            lng: 75.7804,
                            address: 'Kozhikode Beach Road',
                            district: 'Kozhikode',
                            affectedCustomers: 3500,
                            reportedAt: new Date(Date.now() - 30 * 60 * 1000).toISOString(),
                            estimatedRestoration: new Date(Date.now() + 6 * 60 * 60 * 1000).toISOString(),
                            status: 'reported',
                            phone: '+91-495-1234567',
                            team: 'Kozhikode Storm Response Team'
                        }
                    ];

                    // Substation data
                    const substations = [
                        {
                            id: '1',
                            name: 'Thiruvananthapuram 132kV SS',
                            code: 'TVM-132',
                            lat: 8.5241,
                            lng: 76.9361,
                            voltageLevel: '132kV',
                            capacityMva: 50,
                            district: 'Thiruvananthapuram',
                            status: 'operational'
                        },
                        {
                            id: '2',
                            name: 'Kochi 220kV SS',
                            code: 'KCH-220',
                            lat: 10.0168,
                            lng: 76.3418,
                            voltageLevel: '220kV',
                            capacityMva: 100,
                            district: 'Ernakulam',
                            status: 'fault'
                        },
                        {
                            id: '3',
                            name: 'Thrissur 132kV SS',
                            code: 'TSR-132',
                            lat: 10.5276,
                            lng: 76.2144,
                            voltageLevel: '132kV',
                            capacityMva: 75,
                            district: 'Thrissur',
                            status: 'maintenance'
                        },
                        {
                            id: '4',
                            name: 'Kozhikode 132kV SS',
                            code: 'KZD-132',
                            lat: 11.2588,
                            lng: 75.7804,
                            voltageLevel: '132kV',
                            capacityMva: 60,
                            district: 'Kozhikode',
                            status: 'operational'
                        }
                    ];

                    // Create custom icons
                    const createEmergencyIcon = (type, severity) => {
                        const icons = {
                            line_break: '⚡',
                            power_outage: '🔌',
                            equipment_failure: '⚙️',
                            maintenance: '🔧',
                            storm_damage: '⛈️'
                        };
                        
                        const colors = {
                            low: '#10B981',
                            medium: '#F59E0B',
                            high: '#EF4444',
                            critical: '#DC2626'
                        };

                        return L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="
                                background-color: ${colors[severity]};
                                width: 30px;
                                height: 30px;
                                border-radius: 50%;
                                border: 3px solid white;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 14px;
                            ">${icons[type]}</div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15],
                        });
                    };

                    const createSubstationIcon = (status) => {
                        const colors = {
                            operational: '#10B981',
                            maintenance: '#F59E0B',
                            fault: '#EF4444'
                        };

                        return L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="
                                background-color: ${colors[status]};
                                width: 25px;
                                height: 25px;
                                border-radius: 50%;
                                border: 2px solid white;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 12px;
                            ">🏭</div>`,
                            iconSize: [25, 25],
                            iconAnchor: [12.5, 12.5],
                        });
                    };

                    // Add emergency markers with animation and error handling
                    try {
                        emergencies.forEach(emergency => {
                            const marker = L.marker([emergency.lat, emergency.lng], {
                                icon: createEmergencyIcon(emergency.type, emergency.severity)
                            }).addTo(map);

                        // Add pulsing animation for critical and high severity
                        if (emergency.severity === 'critical' || emergency.severity === 'high') {
                            const circle = L.circle([emergency.lat, emergency.lng], {
                                color: emergency.severity === 'critical' ? '#DC2626' : '#EF4444',
                                fillColor: emergency.severity === 'critical' ? '#DC2626' : '#EF4444',
                                fillOpacity: 0.1,
                                radius: 1000
                            }).addTo(map);
                            
                            // Animate the circle
                            let radius = 1000;
                            const animateCircle = () => {
                                radius += 200;
                                circle.setRadius(radius);
                                if (radius < 3000) {
                                    setTimeout(animateCircle, 1000);
                                } else {
                                    radius = 1000;
                                    circle.setRadius(radius);
                                    setTimeout(animateCircle, 2000);
                                }
                            };
                            animateCircle();
                        }

                        const popupContent = `
                            <div style="padding: 8px; min-width: 300px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <h3 style="font-weight: 600; font-size: 16px; margin: 0;">${emergency.title}</h3>
                                    <span style="
                                        padding: 2px 8px;
                                        border-radius: 4px;
                                        font-size: 12px;
                                        font-weight: 600;
                                        background-color: ${emergency.severity === 'critical' ? '#FEE2E2' : emergency.severity === 'high' ? '#FED7AA' : emergency.severity === 'medium' ? '#FEF3C7' : '#D1FAE5'};
                                        color: ${emergency.severity === 'critical' ? '#DC2626' : emergency.severity === 'high' ? '#EA580C' : emergency.severity === 'medium' ? '#D97706' : '#059669'};
                                    ">${emergency.severity.toUpperCase()}</span>
                                </div>
                                <p style="font-size: 14px; color: #6B7280; margin-bottom: 12px;">${emergency.description}</p>
                                
                                <div style="font-size: 12px; margin-bottom: 8px;">
                                    <div style="margin-bottom: 4px;"><strong>📍 Location:</strong> ${emergency.address}</div>
                                    <div style="margin-bottom: 4px;"><strong>👥 Affected:</strong> ${emergency.affectedCustomers.toLocaleString()} customers</div>
                                    <div style="margin-bottom: 4px;"><strong>🕐 Reported:</strong> ${new Date(emergency.reportedAt).toLocaleString()}</div>
                                    <div style="margin-bottom: 4px;"><strong>⏰ Est. Restoration:</strong> ${new Date(emergency.estimatedRestoration).toLocaleString()}</div>
                                </div>
                                
                                <div style="border-top: 1px solid #E5E7EB; padding-top: 8px; margin-top: 8px;">
                                    <div style="font-size: 12px;">
                                        <div style="margin-bottom: 4px;"><strong>📞 Phone:</strong> ${emergency.phone}</div>
                                        <div style="color: #6B7280;">${emergency.team}</div>
                                    </div>
                                </div>
                            </div>
                        `;

                            marker.bindPopup(popupContent);
                        });
                    } catch (error) {
                        console.error('Failed to add emergency markers:', error);
                    }

                    // Add substation markers with error handling
                    try {
                        substations.forEach(substation => {
                            const marker = L.marker([substation.lat, substation.lng], {
                                icon: createSubstationIcon(substation.status)
                            }).addTo(map);

                        const popupContent = `
                            <div style="padding: 8px;">
                                <h3 style="font-weight: 600; font-size: 16px; margin: 0 0 4px 0;">${substation.name}</h3>
                                <p style="font-size: 14px; color: #6B7280; margin: 0 0 8px 0;">${substation.code}</p>
                                
                                <div style="font-size: 12px;">
                                    <div style="margin-bottom: 4px;"><strong>⚡ Voltage:</strong> ${substation.voltageLevel}</div>
                                    <div style="margin-bottom: 4px;"><strong>🏭 Capacity:</strong> ${substation.capacityMva} MVA</div>
                                    <div style="margin-bottom: 4px;"><strong>📍 District:</strong> ${substation.district}</div>
                                    <div style="margin-bottom: 4px;">
                                        <strong>Status:</strong> 
                                        <span style="
                                            padding: 2px 6px;
                                            border-radius: 4px;
                                            font-size: 10px;
                                            font-weight: 600;
                                            background-color: ${substation.status === 'operational' ? '#D1FAE5' : substation.status === 'maintenance' ? '#FEF3C7' : '#FEE2E2'};
                                            color: ${substation.status === 'operational' ? '#059669' : substation.status === 'maintenance' ? '#D97706' : '#DC2626'};
                                        ">${substation.status.toUpperCase()}</span>
                                    </div>
                                </div>
                            </div>
                        `;

                            marker.bindPopup(popupContent);
                        });
                    } catch (error) {
                        console.error('Failed to add substation markers:', error);
                    }

                    // Add real-time updates simulation
                    const updateEmergencyData = () => {
                        try {
                            // Simulate new emergency reports
                            const randomDistricts = ['Kollam', 'Alappuzha', 'Kottayam', 'Idukki', 'Palakkad', 'Malappuram', 'Wayanad', 'Kannur', 'Kasaragod'];
                            const randomTypes = ['line_break', 'power_outage', 'equipment_failure', 'storm_damage'];
                            const randomSeverities = ['low', 'medium', 'high', 'critical'];
                            
                            // Randomly add new emergencies (10% chance every update)
                            if (Math.random() < 0.1) {
                                const district = randomDistricts[Math.floor(Math.random() * randomDistricts.length)];
                                const type = randomTypes[Math.floor(Math.random() * randomTypes.length)];
                                const severity = randomSeverities[Math.floor(Math.random() * randomSeverities.length)];
                                
                                const newEmergency = {
                                    id: Date.now().toString(),
                                    type: type,
                                    severity: severity,
                                    title: `${type.replace('_', ' ').toUpperCase()} - ${district}`,
                                    description: `New ${type.replace('_', ' ')} reported in ${district} district.`,
                                    lat: 8.5 + Math.random() * 3.5, // Kerala latitude range
                                    lng: 75.5 + Math.random() * 2.0, // Kerala longitude range
                                    address: `${district} District`,
                                    district: district,
                                    affectedCustomers: Math.floor(Math.random() * 5000) + 500,
                                    reportedAt: new Date().toISOString(),
                                    estimatedRestoration: new Date(Date.now() + Math.random() * 8 * 60 * 60 * 1000).toISOString(),
                                    status: 'reported',
                                    phone: `+91-${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000000) + 1000000}`,
                                    team: `${district} Emergency Response Team`
                                };
                            
                                const marker = L.marker([newEmergency.lat, newEmergency.lng], {
                                    icon: createEmergencyIcon(newEmergency.type, newEmergency.severity)
                                }).addTo(map);
                            
                                const popupContent = `
                                    <div style="padding: 8px; min-width: 300px;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <h3 style="font-weight: 600; font-size: 16px; margin: 0;">${newEmergency.title}</h3>
                                            <span style="
                                                padding: 2px 8px;
                                                border-radius: 4px;
                                                font-size: 12px;
                                                font-weight: 600;
                                                background-color: ${newEmergency.severity === 'critical' ? '#FEE2E2' : newEmergency.severity === 'high' ? '#FED7AA' : newEmergency.severity === 'medium' ? '#FEF3C7' : '#D1FAE5'};
                                                color: ${newEmergency.severity === 'critical' ? '#DC2626' : newEmergency.severity === 'high' ? '#EA580C' : newEmergency.severity === 'medium' ? '#D97706' : '#059669'};
                                            ">${newEmergency.severity.toUpperCase()}</span>
                                        </div>
                                        <p style="font-size: 14px; color: #6B7280; margin-bottom: 12px;">${newEmergency.description}</p>
                                        
                                        <div style="font-size: 12px; margin-bottom: 8px;">
                                            <div style="margin-bottom: 4px;"><strong>📍 Location:</strong> ${newEmergency.address}</div>
                                            <div style="margin-bottom: 4px;"><strong>👥 Affected:</strong> ${newEmergency.affectedCustomers.toLocaleString()} customers</div>
                                            <div style="margin-bottom: 4px;"><strong>🕐 Reported:</strong> ${new Date(newEmergency.reportedAt).toLocaleString()}</div>
                                            <div style="margin-bottom: 4px;"><strong>⏰ Est. Restoration:</strong> ${new Date(newEmergency.estimatedRestoration).toLocaleString()}</div>
                                        </div>
                                        
                                        <div style="border-top: 1px solid #E5E7EB; padding-top: 8px; margin-top: 8px;">
                                            <div style="font-size: 12px;">
                                                <div style="margin-bottom: 4px;"><strong>📞 Phone:</strong> ${newEmergency.phone}</div>
                                                <div style="color: #6B7280;">${newEmergency.team}</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                
                                marker.bindPopup(popupContent);
                                
                                // Add pulsing animation for critical and high severity
                                if (newEmergency.severity === 'critical' || newEmergency.severity === 'high') {
                                    const circle = L.circle([newEmergency.lat, newEmergency.lng], {
                                        color: newEmergency.severity === 'critical' ? '#DC2626' : '#EF4444',
                                        fillColor: newEmergency.severity === 'critical' ? '#DC2626' : '#EF4444',
                                        fillOpacity: 0.1,
                                        radius: 1000
                                    }).addTo(map);
                                    
                                    // Animate the circle
                                    let radius = 1000;
                                    const animateCircle = () => {
                                        radius += 200;
                                        circle.setRadius(radius);
                                        if (radius < 3000) {
                                            setTimeout(animateCircle, 1000);
                                        } else {
                                            radius = 1000;
                                            circle.setRadius(radius);
                                            setTimeout(animateCircle, 2000);
                                        }
                                    };
                                    animateCircle();
                                }
                                
                                // Show notification
                                console.log(`New emergency reported: ${newEmergency.title} (${newEmergency.severity})`);
                            }
                        }
                    } catch (error) {
                        console.error('Failed to update emergency data:', error);
                    }
                };
                    
                    // Update every 30 seconds and store interval reference
                    updateIntervalRef.current = setInterval(updateEmergencyData, 30000);
                }, 100);
            };

            if (loading || !summary) {
                return (
                    <div className="loading">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                            <p className="mt-4 text-gray-600">Loading dashboard...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <div className="bg-white shadow">
                        <div className="px-6 py-4">
                            <h1 className="text-2xl font-bold text-gray-900">Line Break Detection Dashboard</h1>
                            <p className="text-gray-600">Welcome back, {user?.fullName} • Kerala State Electricity Board</p>
                        </div>
                    </div>

                    <div className="p-6 space-y-6">
                        {/* Stats Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div className="bg-white p-6 rounded-lg shadow">
                                <div className="flex items-center">
                                    <div className="p-2 bg-red-100 rounded-full">
                                        <svg className="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                                        </svg>
                                    </div>
                                    <div className="ml-4">
                                        <p className="text-sm font-medium text-gray-600">Active Events</p>
                                        <p className="text-2xl font-bold text-gray-900">{summary.overview.activeEvents}</p>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow">
                                <div className="flex items-center">
                                    <div className="p-2 bg-blue-100 rounded-full">
                                        <svg className="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                        </svg>
                                    </div>
                                    <div className="ml-4">
                                        <p className="text-sm font-medium text-gray-600">Events Today</p>
                                        <p className="text-2xl font-bold text-gray-900">{summary.overview.totalEventsToday}</p>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow">
                                <div className="flex items-center">
                                    <div className="p-2 bg-green-100 rounded-full">
                                        <svg className="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <div className="ml-4">
                                        <p className="text-sm font-medium text-gray-600">Model Accuracy</p>
                                        <p className="text-2xl font-bold text-gray-900">{(summary.overview.modelAccuracy * 100).toFixed(1)}%</p>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow">
                                <div className="flex items-center">
                                    <div className="p-2 bg-purple-100 rounded-full">
                                        <svg className="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                    </div>
                                    <div className="ml-4">
                                        <p className="text-sm font-medium text-gray-600">Avg Detection Time</p>
                                        <p className="text-2xl font-bold text-gray-900">{summary.performance.avgDetectionTimeMs}ms</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Kerala Emergency Map */}
                        <div className="bg-white p-6 rounded-lg shadow">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold flex items-center gap-2">
                                    <svg className="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                                    </svg>
                                    Kerala Emergency Response Map
                                </h3>
                                <div className="flex items-center gap-2 text-sm text-gray-600">
                                    <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    <span>Live Updates</span>
                                </div>
                            </div>
                            <div className="h-96 rounded-lg overflow-hidden">
                                <div id="kerala-map" style={{ height: '100%', width: '100%' }}></div>
                            </div>
                            <div className="mt-4 grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <h4 className="font-semibold mb-2">Emergency Types</h4>
                                    <div className="space-y-1">
                                        <div className="flex items-center gap-2">
                                            <span className="text-lg">⚡</span>
                                            <span>Line Break</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-lg">🔌</span>
                                            <span>Power Outage</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-lg">⚙️</span>
                                            <span>Equipment Failure</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-lg">⛈️</span>
                                            <span>Storm Damage</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 className="font-semibold mb-2">Severity Levels</h4>
                                    <div className="space-y-1">
                                        <div className="flex items-center gap-2">
                                            <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                                            <span>Low</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <div className="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                            <span>Medium</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <div className="w-3 h-3 bg-orange-500 rounded-full"></div>
                                            <span>High</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <div className="w-3 h-3 bg-red-500 rounded-full"></div>
                                            <span>Critical</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Recent Events */}
                        <div className="bg-white p-6 rounded-lg shadow">
                            <h3 className="text-lg font-semibold mb-4">Recent Events</h3>
                            <div className="space-y-4">
                                {summary.recentEvents.map((event) => (
                                    <div key={event.id} className="border-l-4 border-red-500 bg-gray-50 p-4 rounded">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <h4 className="font-semibold">{event.feederName}</h4>
                                                <p className="text-sm text-gray-600">
                                                    {new Date(event.detectedAt).toLocaleString()} • 
                                                    {event.estimatedLocationKm}km • 
                                                    {event.severity.toUpperCase()}
                                                </p>
                                            </div>
                                            <span className={`px-2 py-1 rounded text-sm ${
                                                event.severity === 'high' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'
                                            }`}>
                                                {event.status}
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Protected Route Component
        const ProtectedRoute = ({ children }) => {
            const { isAuthenticated, isLoading } = useAuth();

            if (isLoading) {
                return (
                    <div className="loading">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                            <p className="mt-4 text-gray-600">Loading...</p>
                        </div>
                    </div>
                );
            }

            return isAuthenticated ? children : <LoginPage />;
        };

        // Main App Component
        const App = () => {
            return (
                <AuthProvider>
                    <BrowserRouter>
                        <Routes>
                            <Route path="/login" component={LoginPage} />
                            <Route path="/" component={() => (
                                <ProtectedRoute>
                                    <DashboardPage />
                                </ProtectedRoute>
                            )} />
                        </Routes>
                    </BrowserRouter>
                </AuthProvider>
            );
        };

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
